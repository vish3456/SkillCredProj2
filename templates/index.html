<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Analyzer Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom spinner for a more modern look */
        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #4f46e5; /* Indigo-600 */
            width: 40px;
            height: 40px;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style for better interactive buttons */
        .interactive-btn {
            transition: all 0.2s ease-in-out;
        }
        .interactive-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4 sm:p-8 min-h-screen">
    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-6 sm:p-10">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-center mb-10 text-indigo-700">
            📰 News Analyzer Pro
        </h1>

        <div class="space-y-10">
            <section>
                <h2 class="text-2xl font-semibold mb-6 pb-2 border-b-2 border-indigo-100 text-indigo-600">
                    Analyze a Single Article
                </h2>

                <div class="space-y-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                    <input type="url" id="urlInput" placeholder="🔗 Paste article URL here..." class="w-full px-5 py-3 rounded-xl border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-300 shadow-sm" list="urlSuggestions">
                    <datalist id="urlSuggestions">
                        <option value="https://www.reuters.com/world/some-sample-article">Reuters Sample</option>
                        <option value="https://www.foxnews.com/politics/some-sample-article">Fox News Sample</option>
                    </datalist>
                    <p class="text-center text-sm font-medium text-gray-500">OR</p>
                    <textarea id="textInput" rows="6" placeholder="✍️ Paste article text here..." class="w-full px-5 py-3 rounded-xl border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-300 shadow-sm"></textarea>
                </div>

                <h3 class="text-xl font-medium mt-6 mb-3 text-gray-700">Choose Analysis Type:</h3>
                <div class="flex flex-wrap gap-4">
                    <button onclick="process('neutral summary')" class="interactive-btn px-6 py-3 bg-indigo-600 text-white rounded-full font-bold shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                        ✨ Neutral Summary
                    </button>
                    <button onclick="process('fact-only')" class="interactive-btn px-6 py-3 bg-indigo-600 text-white rounded-full font-bold shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                        📄 Fact-Only Summary
                    </button>
                    <button onclick="process('explain to a 10-year-old')" class="interactive-btn px-6 py-3 bg-indigo-600 text-white rounded-full font-bold shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                        👶 Explain to a 10-Year-Old
                    </button>
                </div>
            </section>

            <hr class="border-gray-200">

            <section>
                <h2 class="text-2xl font-semibold mb-6 pb-2 border-b-2 border-rose-100 text-rose-600">
                    Compare Multiple Sources
                </h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="queryInput" placeholder="🔍 Enter a topic (e.g., 'recent elections' or 'space travel')" class="w-full sm:flex-grow px-5 py-3 rounded-xl border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:border-rose-500 transition duration-300 shadow-sm">
                    <button onclick="compareSources()" class="interactive-btn px-8 py-3 bg-rose-500 text-white rounded-xl font-bold shadow-md hover:bg-rose-600 transition duration-300 focus:outline-none focus:ring-4 focus:ring-rose-300">
                        Compare Sources
                    </button>
                </div>
                <div id="comparisonLoading" class="hidden text-center mt-6">
                    <div class="loading-spinner"></div>
                    <p class="text-rose-500 font-medium">Fetching and analyzing sources...</p>
                </div>
            </section>
        </div>

        <div id="resultsContainer" class="mt-12 space-y-8">
            <div id="loadingIndicator" class="hidden text-center mt-4">
                <div class="loading-spinner"></div>
                <p class="text-indigo-500 font-medium">Analyzing... please wait</p>
            </div>

            <div id="singleArticleResults" class="p-6 bg-white border border-indigo-200 rounded-xl shadow-lg hidden">
                <h3 class="text-2xl font-bold mb-4 text-indigo-700 border-b pb-2">Analysis Results:</h3>

                <h4 class="text-xl font-bold mb-2 text-gray-800">Summary:</h4>
                <p id="summaryOutput" class="mb-6 text-gray-700 leading-relaxed italic"></p>

                <h4 class="text-xl font-bold mb-2 text-gray-800">Sentiment & Potential Bias:</h4>
                <div id="biasVisual" class="h-8 rounded-full mb-3 shadow-inner" title="Visual Sentiment Score"></div>
                <p id="biasOutput" class="text-gray-700 font-medium"></p>
            </div>

            <div id="comparisonResults" class="p-6 bg-white border border-rose-200 rounded-xl shadow-lg hidden">
                <h3 class="text-2xl font-bold mb-4 text-rose-700 border-b pb-2">Source Comparison:</h3>
                <h4 class="text-xl font-bold mb-2 text-gray-800">Sentiment Comparison:</h4>
                <canvas id="biasChart" class="mt-4"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Utility function to determine color based on sentiment label
        function getSentimentColor(sentiment) {
            if (sentiment === "POSITIVE") return 'bg-green-500';
            if (sentiment === "NEGATIVE") return 'bg-red-500';
            return 'bg-gray-500'; // NEUTRAL
        }

        async function process(tone) {
            const url = document.getElementById('urlInput').value.trim();
            const text = document.getElementById('textInput').value.trim();
            const loadingDiv = document.getElementById('loadingIndicator');
            const singleArticleResultsDiv = document.getElementById('singleArticleResults');
            const biasVisualDiv = document.getElementById('biasVisual');

            if (!url && !text) {
                alert("Please provide a URL or paste text.");
                return;
            }

            singleArticleResultsDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');

            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url, text: text, tone: tone })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Something went wrong.');
                }

                const data = await response.json();

                // 1. Update Bias Visualizer
                const sentimentMatch = data.bias_flag.match(/(\w+) \(Score: ([\d.]+)\)/);
                if (sentimentMatch) {
                    const sentimentLabel = sentimentMatch[1];
                    const sentimentScore = parseFloat(sentimentMatch[2]);

                    // Clear existing classes
                    biasVisualDiv.className = 'h-8 rounded-full mb-3 shadow-inner transition-all duration-500';

                    // Set color and width based on score
                    const colorClass = getSentimentColor(sentimentLabel);

                    // Calculate visual score width: from 0.0 to 1.0, scale to 0% to 100%
                    let visualWidth = Math.round(sentimentScore * 100);

                    // For visual effect, let's make NEGATIVE scores use a different range (e.g., center to left)
                    if (sentimentLabel === 'NEGATIVE') {
                        // The actual score for NEGATIVE is closer to 1.0, but we want it visually on the "bad" side.
                        // We'll use 1.0 - score as a proxy for the 'negative strength'
                        // E.g., Score 0.9 (Negative) means 10% bias, Score 0.6 (Negative) means 40% bias.
                        // For simplicity in a single bar:
                        // POSITIVE: width is score
                        // NEGATIVE: width is 1 - score (to show a full bar for the strongest negative)
                        // NEUTRAL: width is just a default medium size (e.g., 50%)
                        visualWidth = 100 - visualWidth;

                        // We'll use a gradient to make it look like a meter from center
                        // This is complex in pure Tailwind. Let's simplify and just color the entire bar
                        // and show a proportional color strip inside.
                        biasVisualDiv.style.background = `linear-gradient(to right, ${sentimentLabel === 'NEGATIVE' ? 'rgba(255, 99, 132, 1)' : (sentimentLabel === 'POSITIVE' ? 'rgba(75, 192, 192, 1)' : 'rgba(201, 203, 207, 1)')} ${visualWidth}%, #e5e7eb ${visualWidth}%)`;
                    } else {
                        biasVisualDiv.style.background = `linear-gradient(to right, ${sentimentLabel === 'POSITIVE' ? 'rgba(75, 192, 192, 1)' : (sentimentLabel === 'NEGATIVE' ? 'rgba(255, 99, 132, 1)' : 'rgba(201, 203, 207, 1)')} ${visualWidth}%, #e5e7eb ${visualWidth}%)`;
                    }


                }

                // 2. Update Text Outputs
                document.getElementById('summaryOutput').textContent = data.summary;
                document.getElementById('biasOutput').textContent = data.bias_flag;

                singleArticleResultsDiv.classList.remove('hidden');
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }

        let myChart; // To store the chart instance
        async function compareSources() {
            const query = document.getElementById('queryInput').value.trim();
            const loadingDiv = document.getElementById('comparisonLoading');
            const comparisonResultsDiv = document.getElementById('comparisonResults');

            if (!query) {
                alert("Please enter a topic to compare.");
                return;
            }

            comparisonResultsDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');

            try {
                const response = await fetch('/compare', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Something went wrong.');
                }

                const data = await response.json();

                if (myChart) {
                    myChart.destroy();
                }

                const sources = data.results.map(res => res.source);
                const scores = data.results.map(res => res.score);
                const sentiments = data.results.map(res => res.sentiment);

                const backgroundColors = sentiments.map(sentiment => {
                    if (sentiment === "POSITIVE") return 'rgba(75, 192, 192, 0.8)'; // Teal/Green
                    if (sentiment === "NEGATIVE") return 'rgba(255, 99, 132, 0.8)'; // Red/Rose
                    return 'rgba(201, 203, 207, 0.8)'; // Grey
                });

                const borderColors = backgroundColors.map(color => color.replace('0.8', '1'));


                const ctx = document.getElementById('biasChart').getContext('2d');
                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sources,
                        datasets: [{
                            label: 'Sentiment Score',
                            data: scores,
                            backgroundColor: backgroundColors,
                            borderColor: borderColors,
                            borderWidth: 1.5,
                            borderRadius: 6, // Rounded bars for a modern look
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false,
                            },
                            title: {
                                display: true,
                                text: `Sentiment Analysis for: "${query}"`,
                                font: {
                                    size: 16
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false, // Start at 0 is visually better for scores
                                max: 1.0,
                                min: 0.0,
                                title: {
                                    display: true,
                                    text: 'Sentiment Score (0.0 to 1.0)',
                                    color: '#4b5563' // gray-600
                                },
                                ticks: {
                                    stepSize: 0.1
                                }
                            },
                            x: {
                                grid: {
                                    display: false // Less clutter
                                }
                            }
                        }
                    }
                });

                comparisonResultsDiv.classList.remove('hidden');
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
